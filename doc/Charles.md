# Charles
---
[Charles官网](http://www.charlesproxy.com)

Charles是在mac下常用的截取网络封包的工具，在做iOS开发时，我们为了调试与服务器端的接口，常常需要截取网络封包来分析。Charles可以帮助我们方便地调试与服务器端的通讯协议。

## Charles简介
![Charles](http://ot22ho57o.bkt.clouddn.com/charles.png)

Charles是在Mac下常用的截取网络封包的工具，在做iOS开发时，我们为了调试与服务器端的网络通讯协议，常常需要截取网络封包来分析。Charles通过将自己设置成系统的网络访问代理服务器，使得所有的网络访问请求都通过它来完成，从而实现了网络封包的截取和分析。

Charles是收费软件，可以免费试用30天。试用期过后，未付费的用户仍然可以继续使用，但是每次使用时间不能超过30分钟，并且启动时将会有10秒种的延时。

因此，该付费方案对广大用户还是相当友好的，即使你长期不付费，也能使用完整的软件功能。只是当你需要长时间进行封包调试时，会因为Charles强制关闭而受到影响。

Charles主要的功能包括:

1. 支持SSL代理。可以截取分析SSL的请求。
2. 支持流量控制。可以模拟慢速网络，以及等待时间(latency)较长的请求。  
3. 支持AJAX调试。可以自动将json或xml数据格式化，方便查看。  
4. 支持AMF调试。可以将Flash Remoting或Flex Remoting信息格式化，方便查看。  
5. 支持重发网络请求，方便后端调试。  
6. 支持修改网络请求参数。  
6. 支持网络请求的截获并动态修改。  
8. 检查HTML、CSS和RSS内容是否符合[W3C](http://validator.w3.org)标准。

## Charles的安装和使用

### 安装Charles
去Charles的官方网站下载最新版的安装包，它是一个.dmg后缀的文件。打开后将其拖到Application目录下即完成安装。

### 安装SSL证书
如果你需要截取分析SSL协议相关的内容。那么需要安装Charles的SSL证书。具体步骤如下:

1. 去[这里](http://www.charlesproxy.com/ssl.zip)下载CA证书文件。
2. 解压该zip文件后，双击其中的.crt文件，这时候在弹出的菜单中选择“总是信任”。
3. 从钥匙串访问中即可看到添加成功的证书。

### 将Charles设置成系统代理
之前提到，Charles是通过将自己设置成代理服务器来完成封包截取的，所以使用Charles的第一步是将其设置成系统的代理服务器。

第一次启动Charles后，Charles会请求你给它设置系统代理的权限。你可以输入登录密码授予Charles该权限，也可以忽略该请求，然后在需要将Charles设置成系统代理时，选择菜单中的“Proxy” -> “Mac OS X Proxy”来将Charles设置成系统代理。

之后，你就可以看到源源不断的网络请求出现在Charles的界面中。

### Charles主界面介绍
Charles主要提供两种查看封包的视图，分别名为“Structure” 和 “Sequence”。

1. Structure视图将网络请求按访问的域名分类。
2. Sequence视图将网络请求按访问的时间排序。

可以根据具体的需要在这两种视图之间来回切换。 

对于某一个具体的网络请求，你可以查看其详细的请求内容和响应内容。如果响应内容是JSON格式的，那么Charles可以自动帮你将JSON内容格式化，方便你查看。

### 过滤网络请求
通常情况下，我们需要对网络请求进行过滤，只监控向指定目录服务器上发送的请求。对于这种需求，我们有两种办法：

1. 在主界面的中部的Filter栏中填入需要过滤出来的关键字。例如服务器的地址是`https://www.baidu.com`，那么只需要在Filter栏中填入baidu即可。
2. 在Charles的菜单栏选择“Proxy” -> “Recording Setting”，然后选择Include栏，选择添 加一个项目，然后填入需要监控的协议、主机地址、端口号。这样就可以只截取目标网站的封包了。

通常情况下，我们使用方法   做一些临时性的封包过滤，使用方法   做一些经常性的封包过 滤。

## 使用Charles协助iOS开发

### 截取iPhone上的网络封包
Charles通常用来截取本地的网络封包，但是当需要时，我们也可以用它来截取其他设备上的网络请求。下面我就以iPhone为例，讲解如何进行相应操作。

#### Charles上的设置
要截取iPhone上的网络请求，我们首先需要将Charles的代理功能打开。在         的菜单 栏上选择“Proxy” -> “Recording Setting”，填入代理端口8888，并且勾选“Enable transparent HTTP proxying”，就完成了在         上的设置。

#### iPhone上的设置
首先我们需要获取Charles运行所在的电脑的IP地址，打开Terminal，输入ifconfig en0即可获得该电脑的IP。

在iPhone的“设置” -> “无线局域网”中，可以看到当前连接的WIFI名，通过点击右边的详情键，可以看到当前连接上的WIFI的详细信息，包括IP地址、子网掩码等信息。在其最底部有“HTTP代理”一项，我们将其切换成手动，然后填上Charles运行所在的电脑的IP，以及端口号8888。

设置好之后，我们打开iPhone上的任意需要网络通讯的程序，就可以看到Charles弹出iPhone请求连接的确认菜单(如下图所示)，点击“Allow”即可完成设置。

### 模拟慢速网络
在做iPhone开发的时候，我们常常需要模拟慢速网络或者高延迟的网络，以测试在移动网络下应用的表现是否正常。Charles对此需求提供了很好的支持。

在Charles的菜单上，选择“Proxy” -> “Throttle Setting”项，在之后弹出的对话框中，我们可以勾选上“Enable throttling”，并且可以设置Throttle Preset的类型。

如果我们只想模拟指定网站的慢速网络，可以再勾选上图中的“Only for selected hosts”项， 然后在对话框的下半部分设置中增加指定的hosts项即可。

### 高级功能

#### 获取SSL信息
Charles默认并不截取SSL的信息，如果你想截取某个网站上的所有SSL网络请求，可以在该请求上单击鼠标右键，选择“SSL Proxying”。

这样，对于该Host的所有SSL请求都可以被截取到了。

#### 修改网络请求内容
有些时候为了调试服务器的接口，我们需要反复尝试不同参数的网络请求。        Charles可以方便地提供网络请求的修改和重发功能。只需要在以往的网络请求上点击右键，选择“Edit”， 即可创建一个可编辑的网络请求。

我们可以修改该请求的任何信息，包括url地址、端口、参数等，之后点击“Execute”即可 发送该修改后的网络请求(如下图所示)。Charles支持我们多次修改和发送该请求，这对于 我们和服务器端调试接口非常方便。

#### 修改服务器返回内容
有些时候我们想让服务器返回一些指定的内容，方便我们在一些特殊情况下的调试。例如列表页面为空的情况，数据异常的情况，部分耗时的网络请求超时的情况等。如果没有Charles，要服务器配合构造相应的数据显得会比较麻烦。这个时候，使用Charles相关的功能就可以满足我们的需求。

根据具体的需求，Charles提供了Map功能、Rewrite功能及Breakpoints功能，它们都可以达到修改服务器返回内容的目的。这三者在功能上的差异是:

1. Map功能适合长期地将某一些请求重定向到另一个网络地址或本地文件。
2. Rewrite功能适合对网络请求进行一些正则替换。
3. Breakpoints功能适合做一些临时性的修改。

### Map功能
Charles的Map功能分Map remote和Map Local两种，顾名思义，Map remote是将指定的网络请求重定向到另一个网址请求地址，Map Local是将指定的网络请求重定向到本地文件。

在Charles的菜单中，选择“Tools” -> “Map remote” 或 “Map Local”即可进入相应功能。

对于Map remote功能，我们需要分别填写网络重定向的源地址和目的地址，对于不需要限 制的条件，可以留空。下图是一个示例，将所有ytkl.yuanku.ws(测试服务器)的请求重定向到了www.yuantiku.com(线上服务器)。

对于Map Local功能，我们需要填写重定向的源地址和本地的目标文件。对于一些复杂的网 络请求结果，我们可以先使用Charles提供的“Save Response...”功能，将请求结果保存到本 地(如下图所示)，然后稍加修改，使其成为我们的目标映射文件。

下图是一个示例，将一个指定的网络请求通过Map Local功能映射到了本地的一个经过修改 的文件中。

### Rewrite功能
Rewrite功能适合对某一类网络请求进行一些正则替换，以达到修改结果的目的。例如，我们的客户端有一个API请求是获得用户昵称，而我当前的昵称是“test”。

我们想试着直接修改网络返回值，将test换成iOS。于是我们启用Rewrite功能，然后设置。

完成设置之后，我们就可以从Charles中看到，之后的API获得的昵称被自动         成了iOS。


#### Breakpoints功能
上面提供的Rewrite功能最适合做批量和长期的替换，但是很多时候，我们只是想临时修改一次网络请求结果，这个时候，使用Breakpoints功能虽然也可以达到目的，但是过于麻烦。

Breakpoints功能类似我们在Xcode中设置的断点，当指定的网络请求发生时，Charles会截获该请求，这个时候，我们可以在Charles中临时修改网络请求的返回内容。

#### 总结
通过Charles软件，我们可以很方便地在日常开发中截取和调试网络请求内容，分析封包协议，以及模拟慢速网络。用好Charles可以极大地方便我们对于带有网络请求的应用的开发 和调试。

#### 参考链接

1. Charles主要的功能列表[点击进入](http://www.charlesprocy.com/overview/about-charles)
